#!/usr/bin/env bash

set -ex

workspace_dir="$( pwd )"
updated_capi_ci_private="${workspace_dir}/updated-capi-ci-private"
output_path="${updated_capi_ci_private}/${ENVIRONMENT}"
delete_var_store_script="${workspace_dir}/capi-ci/ci/bbl-tasks/delete-var-store-certs.rb"

function delete_bbl_certs() {
  ${delete_var_store_script} ${output_path}/vars/director-vars-store.yml
  ${delete_var_store_script} ${output_path}/vars/jumpbox-vars-store.yml
}

function commit_capi_ci_private() {
  if [[ -n $(git status --porcelain) ]]; then
    git config user.name "CI Bot"
    git config user.email "cf-capi-eng@pivotal.io"

    git add "${updated_capi_ci_private}/${ENVIRONMENT}"
    git commit -m "Initial commit for '${ENVIRONMENT}'"
  fi
}

cp -rf capi-ci-private/* ${updated_capi_ci_private}

mkdir -p "${updated_capi_ci_private}/${ENVIRONMENT}"
pushd "${updated_capi_ci_private}/${ENVIRONMENT}"
  delete_bbl_certs

  commit_capi_ci_private
popd
