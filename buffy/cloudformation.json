{
  "AWSTemplateFormatVersion": "2010-09-09",

  "Description": "Infrastructure for Bosh Lite",

  "Parameters": {
    "VPCCIDR": {
      "Description": "CIDR block for the VPC.",
      "Type": "String",
      "Default": "10.0.0.0/16"
    },
    "BuffyCIDR": {
      "Description": "CIDR block for the Internal subnet 1.",
      "Type": "String",
      "Default": "10.0.32.0/20"
    }
  },

  "Resources": {
    "BuffyVPC": {
      "Type": "AWS::EC2::VPC",
      "Properties": { "CidrBlock": { "Ref": "VPCCIDR" } }
    },

    "BuffyInternetGateway": {
      "Type": "AWS::EC2::InternetGateway"
    },

    "BuffyGatewayAttachment": {
      "Type": "AWS::EC2::VPCGatewayAttachment",
      "Properties": {
        "VpcId": { "Ref": "BuffyVPC" },
        "InternetGatewayId": { "Ref": "BuffyInternetGateway" }
      }
    },

    "BuffySecure": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "VpcId": { "Ref": "BuffyVPC" },
        "GroupDescription": "Internal",
        "SecurityGroupEgress": [],
        "SecurityGroupIngress": [
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "tcp",
            "FromPort": "0",
            "ToPort": "65535"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "udp",
            "FromPort": "0",
            "ToPort": "65535"
          },
          {
            "CidrIp": "0.0.0.0/0",
            "IpProtocol": "icmp",
            "FromPort": "-1",
            "ToPort": "-1"
          }
        ]
      }
    },

    "BuffySubnet": {
      "Type": "AWS::EC2::Subnet",
      "Properties": {
        "AvailabilityZone": { "Fn::Select": ["0", { "Fn::GetAZs": { "Ref" : "AWS::Region" } }] },
        "CidrBlock": { "Ref": "BuffyCIDR" },
        "VpcId": { "Ref": "BuffyVPC" },
        "Tags": [{ "Key": "Name", "Value": "BuffySubnet" }]
      }
    },

    "BoshLiteElasticIP": {
      "Type": "AWS::EC2::EIP",
      "Properties" : {
        "Domain" : "vpc"
      }
    },

    "BuffyRouteTable": {
      "Type": "AWS::EC2::RouteTable",
      "Properties": { "VpcId": { "Ref": "BuffyVPC" } }
    },

    "BuffyRoute": {
      "Type": "AWS::EC2::Route",
      "DependsOn": "BuffyInternetGateway",
      "Properties": {
        "DestinationCidrBlock": "0.0.0.0/0",
        "GatewayId": { "Ref": "BuffyInternetGateway" },
        "RouteTableId": { "Ref": "BuffyRouteTable" }
      }
    },

    "BuffySubnetRouteTableAssociation": {
      "Type": "AWS::EC2::SubnetRouteTableAssociation",
      "Properties": {
        "RouteTableId": { "Ref": "BuffyRouteTable" },
        "SubnetId": { "Ref": "BuffySubnet" }
      }
    }
  }
}
